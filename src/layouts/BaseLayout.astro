---
import '../styles/global.css';
import Nav from '../components/Nav.astro';
import Footer from '../components/Footer.astro';
import Noise from '../components/Noise';
import ClickSpark from '../components/ClickSpark';
import SearchDialog from '../components/SearchDialog';
import NavDock from '../components/NavDock';
import CyberEffects from '../components/CyberEffects';
import { SITE_TITLE } from '../consts';

interface Props {
  title: string;
  description?: string;
}

const { title, description = '' } = Astro.props;
const canonicalURL = new URL(Astro.url.pathname, Astro.site);
---

<!doctype html>
<html lang="zh-CN" class="dark">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="generator" content={Astro.generator} />
    {description && <meta name="description" content={description} />}
    <meta property="og:title" content={title} />
    {description && <meta property="og:description" content={description} />}
    <meta property="og:type" content="website" />
    <meta property="og:url" content={canonicalURL} />
    <link rel="canonical" href={canonicalURL} />
    <link rel="alternate" type="application/rss+xml" title={SITE_TITLE} href="/rss.xml" />
    <title>{title}</title>

    <!-- Dark mode + locale init (runs before paint to prevent flash) -->
    <script is:inline>
      (function() {
        var theme = localStorage.getItem('theme');
        if (theme === 'light') {
          document.documentElement.classList.remove('dark');
        } else {
          document.documentElement.classList.add('dark');
        }
        var locale = localStorage.getItem('locale');
        if (locale && ['zh','en','ja','es'].includes(locale)) {
          document.documentElement.lang = locale === 'zh' ? 'zh-CN' : locale;
        }
      })();
    </script>
  </head>
  <body class="min-h-screen bg-background text-foreground antialiased">
    <!-- Film grain overlay -->
    <div class="fixed inset-0 z-[100] pointer-events-none opacity-[0.03]">
      <Noise client:idle patternAlpha={12} patternRefreshInterval={3} />
    </div>

    <!-- Background ribbons (desktop only) -->
    <CyberEffects client:idle />

    <!-- Search dialog (keep client:load for keyboard shortcut) -->
    <SearchDialog client:load />

    <!-- Dock navigation (desktop) -->
    <NavDock client:idle />

    <!-- Click spark effect -->
    <ClickSpark client:idle sparkColor="oklch(0.82 0.15 192)" sparkSize={10} sparkCount={8} duration={400}>
      <Nav />
      <main class="mx-auto max-w-3xl px-6 pt-24 pb-16 lg:pb-24 relative z-10">
        <slot />
      </main>
      <Footer />
    </ClickSpark>
    <script>
      import { getLocale, applyTranslations } from '../lib/i18n';
      const locale = getLocale();
      if (locale !== 'zh') applyTranslations(locale);
    </script>
  </body>
</html>
