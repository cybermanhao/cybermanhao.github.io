---
import type { ImageMetadata } from 'astro';
import { Image } from 'astro:assets';
import { Badge } from './ui/badge';
import SpotlightCard from './SpotlightCard';
import { LANG_FLAGS } from '../lib/blog';

interface Props {
  title: string;
  description: string;
  pubDate: Date;
  tags: string[];
  slug: string;
  cover?: ImageMetadata | string;
  lang?: string;
}

const { title, description, pubDate, tags, slug, cover, lang } = Astro.props;
const isLocalImage = cover && typeof cover !== 'string';
const flag = lang ? LANG_FLAGS[lang] || lang : undefined;
---

<SpotlightCard
  client:visible
  className="bg-card border border-border rounded-xl overflow-hidden h-full"
  spotlightColor="rgba(0, 212, 255, 0.08)"
>
  <a href={`/blog/${slug}`} class="block group h-full">
    <div class="flex flex-col h-full">
      {cover && (
        <div class="aspect-[4/3] overflow-hidden relative bg-muted crt-overlay">
          <div class="shimmer-overlay absolute inset-0 flex items-center justify-center">
            <div class="absolute inset-0 -translate-x-full animate-[shimmer_2s_infinite] bg-gradient-to-r from-transparent via-foreground/5 to-transparent"></div>
          </div>
          {isLocalImage ? (
            <Image
              src={cover as ImageMetadata}
              alt={title}
              widths={[400, 600]}
              sizes="(max-width: 768px) 100vw, 50vw"
              class="w-full h-full object-cover object-[center_20%] group-hover:scale-105 transition-all duration-500 opacity-0"
              onload="this.classList.remove('opacity-0');this.classList.add('opacity-100');this.parentElement.querySelector('.shimmer-overlay').remove()"
            />
          ) : (
            <img
              src={cover as string}
              alt={title}
              loading="lazy"
              class="w-full h-full object-cover object-[center_20%] group-hover:scale-105 transition-all duration-500 opacity-0"
              onload="this.classList.remove('opacity-0');this.classList.add('opacity-100');this.parentElement.querySelector('.shimmer-overlay').remove()"
            />
          )}
          {flag && (
            <span class="absolute top-2 right-2 text-sm bg-background/80 backdrop-blur-sm rounded px-1.5 py-0.5 border border-border leading-none">
              {flag}
            </span>
          )}
        </div>
      )}

      <div class="p-6 flex flex-col flex-1">
        <div class="flex items-center gap-3 text-xs text-muted-foreground mb-3">
          <time datetime={pubDate.toISOString()}>
            {pubDate.toLocaleDateString('zh-CN', {
              year: 'numeric',
              month: 'short',
              day: 'numeric',
            })}
          </time>
        </div>

        <h3 class="text-lg font-semibold font-tech group-hover:text-primary group-hover:tracking-wider transition-all duration-300 mb-2 line-clamp-2 min-h-[2lh]">
          {title}
        </h3>

        <p class="text-sm text-muted-foreground flex-1 mb-4 line-clamp-2">
          {description}
        </p>

        {tags.length > 0 && (
          <div class="flex flex-wrap gap-1.5">
            {tags.slice(0, 3).map((tag: string) => (
              <Badge variant="outline" className="text-[10px] font-tech">
                #{tag}
              </Badge>
            ))}
          </div>
        )}
      </div>
    </div>
  </a>
</SpotlightCard>
