---
import type { ImageMetadata } from 'astro';
import BaseLayout from '../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import { SITE_TITLE, SITE_DESCRIPTION } from '../consts';
import HeroSection from '../components/HeroSection';
import PostCard from '../components/PostCard.astro';
import BlurText from '../components/BlurText';
import FadeContent from '../components/FadeContent';
import LogoLoop from '../components/LogoLoop';
import { getPostSlug, prefetchWaifuBatch, resolvePostCover } from '../lib/blog';

const allPosts = (await getCollection('blog'))
  .filter((post) => !post.data.draft)
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf())
  .slice(0, 6);

// Pre-fetch waifu URLs in one parallel batch for posts without covers
const uncoveredCount = allPosts.filter((p) => !p.data.cover).length;
await prefetchWaifuBatch(uncoveredCount);

const posts = await Promise.all(
  allPosts.map(async (post) => ({
    ...post,
    cover: await resolvePostCover(post.data.cover) as ImageMetadata | string | undefined,
  }))
);

const techLogos = [
  { node: 'Astro' },
  { node: 'React' },
  { node: 'TypeScript' },
  { node: 'Tailwind' },
  { node: 'Node.js' },
  { node: 'Python' },
  { node: 'Next.js' },
  { node: 'Vue' },
  { node: 'GSAP' },
  { node: 'GraphQL' },
];
---

<BaseLayout title={SITE_TITLE} description={SITE_DESCRIPTION}>
  <!-- Hero -->
  <HeroSection client:idle />

  <!-- Recent Posts -->
  <section class="mt-20">
    <div class="mb-8">
      <BlurText
        client:visible
        text="最新文章"
        className="text-2xl font-bold font-tech"
        delay={100}
        animateBy="letters"
      />
    </div>

    {posts.length === 0 ? (
      <p class="text-muted-foreground">暂无文章，敬请期待！</p>
    ) : (
      <div class="grid gap-4 md:grid-cols-2">
        {posts.map((post, i) => (
          <FadeContent client:visible delay={i * 100} duration={600} blur={true}>
            <PostCard
              title={post.data.title}
              description={post.data.description}
              pubDate={post.data.pubDate}
              tags={post.data.tags}
              slug={getPostSlug(post.id)}
              cover={post.cover}
            />
          </FadeContent>
        ))}
      </div>
    )}

    <div class="mt-8 text-center">
      <a
        href="/blog"
        class="inline-flex items-center gap-2 px-5 py-2.5 text-sm font-tech font-medium border border-border rounded-lg hover:border-primary/50 hover:bg-muted transition-colors"
      >
        查看全部文章
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M13 7l5 5m0 0l-5 5m5-5H6" />
        </svg>
      </a>
    </div>
  </section>

  <!-- Tech Stack Marquee -->
  <section class="mt-20 mb-8">
    <p class="text-center text-xs text-muted-foreground font-tech uppercase tracking-widest mb-6">
      Tech Stack
    </p>
    <LogoLoop
      client:visible
      logos={techLogos}
      speed={30}
      direction="left"
      pauseOnHover={true}
      fadeOut={true}
      gap={48}
      logoHeight={24}
    />
  </section>
</BaseLayout>
