---
import type { ImageMetadata } from 'astro';
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import PostCard from '../../components/PostCard.astro';
import FadeContent from '../../components/FadeContent';
import SplitText from '../../components/SplitText';
import { getPostSlug, prefetchWaifuBatch, resolvePostCover } from '../../lib/blog';

const allPosts = (await getCollection('blog'))
  .filter((post) => !post.data.draft)
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

// Pre-fetch waifu URLs in one parallel batch for posts without covers
const uncoveredCount = allPosts.filter((p) => !p.data.cover).length;
await prefetchWaifuBatch(uncoveredCount);

const posts = await Promise.all(
  allPosts.map(async (post) => ({
    ...post,
    cover: await resolvePostCover(post.data.cover) as ImageMetadata | string | undefined,
  }))
);

const allTags = [...new Set(allPosts.flatMap((p) => p.data.tags))].sort();
const VISIBLE_COUNT = 10;
const extraCount = Math.max(0, allTags.length - VISIBLE_COUNT);
---

<BaseLayout title="博客 — 限制解除！" description="所有博客文章">
  <div class="mb-8">
    <SplitText
      client:visible
      text="博客文章"
      tag="h1"
      splitType="chars"
      delay={40}
      duration={0.8}
      ease="power3.out"
      textAlign="left"
      className="text-3xl font-bold font-tech"
    />
  </div>

  {allTags.length > 0 && (
    <div id="tag-bar" class="mb-8 flex flex-wrap items-center gap-2">
      <button
        data-tag=""
        data-active
        class="tag-btn inline-flex items-center justify-center rounded-full border px-2 py-0.5 text-xs font-medium font-tech cursor-pointer transition-colors"
      >
        <span data-i18n="blog.all">全部</span>
      </button>
      {allTags.map((tag, i) => (
        <button
          data-tag={tag}
          class="tag-btn inline-flex items-center justify-center rounded-full border px-2 py-0.5 text-xs font-medium font-tech cursor-pointer transition-colors"
          {...(i >= VISIBLE_COUNT ? { 'data-extra-tag': '' } : {})}
        >
          #{tag}
        </button>
      ))}
      {extraCount > 0 && (
        <button
          id="tag-toggle"
          class="inline-flex items-center justify-center rounded-full border border-dashed border-border px-2 py-0.5 text-xs font-medium font-tech cursor-pointer text-muted-foreground hover:text-foreground transition-colors"
        >
          展开 (+{extraCount})
        </button>
      )}
    </div>
  )}

  <!-- Language notice for non-zh visitors -->
  <div data-lang-notice class="mb-6 px-4 py-2.5 rounded-lg bg-muted/50 border border-border text-sm text-muted-foreground text-center font-tech" style="display:none">
    The blogger mainly writes in Chinese ✧(≖ ◡ ≖✿)
  </div>

  <p id="empty-msg" class="text-muted-foreground py-12 text-center" data-i18n="blog.noResults" style="display:none">没有找到相关文章</p>

  <div id="post-grid" class="grid gap-4 md:grid-cols-2">
    {posts.map((post, i) => (
      <div data-tags={post.data.tags.join(',')} data-lang={post.data.lang || 'zh'} class="h-full">
        <FadeContent client:visible delay={i * 80} duration={500} blur={true}>
          <PostCard
            title={post.data.title}
            description={post.data.description}
            pubDate={post.data.pubDate}
            tags={post.data.tags}
            slug={getPostSlug(post.id)}
            cover={post.cover}
            lang={post.data.lang || 'zh'}
          />
        </FadeContent>
      </div>
    ))}
  </div>
</BaseLayout>

<style>
  .tag-btn {
    border-color: var(--color-border);
    color: var(--color-foreground);
  }
  .tag-btn:hover {
    background-color: color-mix(in srgb, var(--color-primary) 10%, transparent);
  }
  .tag-btn[data-active] {
    background-color: var(--color-primary);
    color: var(--color-primary-foreground);
    border-color: var(--color-primary);
  }
  /* Extra tags hidden by default, shown when tag-bar has data-expanded */
  .tag-btn[data-extra-tag] {
    display: none;
  }
  #tag-bar[data-expanded] .tag-btn[data-extra-tag] {
    display: inline-flex;
  }
</style>

<script>
  const tagBar = document.getElementById('tag-bar');
  const toggleBtn = document.getElementById('tag-toggle');
  const postGrid = document.getElementById('post-grid');
  const emptyMsg = document.getElementById('empty-msg');
  if (!tagBar || !postGrid) throw new Error('Missing DOM');

  const tagBtns = tagBar.querySelectorAll<HTMLButtonElement>('.tag-btn');
  const extraTags = tagBar.querySelectorAll<HTMLButtonElement>('[data-extra-tag]');
  const postItems = postGrid.querySelectorAll<HTMLDivElement>('[data-tags]');
  let expanded = false;

  // Collapse / Expand (i18n-aware)
  import { getLocale, t } from '../../lib/i18n';
  const locale = getLocale();
  const expandLabel = (t['blog.expand']?.[locale] || '展开') + ` (+${extraTags.length})`;
  const collapseLabel = t['blog.collapse']?.[locale] || '收起';

  toggleBtn?.addEventListener('click', () => {
    expanded = !expanded;
    if (expanded) {
      tagBar.setAttribute('data-expanded', '');
    } else {
      tagBar.removeAttribute('data-expanded');
    }
    toggleBtn.textContent = expanded ? collapseLabel : expandLabel;
  });

  // Tag filtering
  tagBtns.forEach((btn) => {
    btn.addEventListener('click', () => {
      const tag = btn.dataset.tag!;

      // Update active state
      tagBtns.forEach((b) => b.removeAttribute('data-active'));
      btn.setAttribute('data-active', '');

      // Filter posts
      let visibleCount = 0;
      postItems.forEach((item) => {
        const tags = item.dataset.tags!.split(',');
        const show = tag === '' || tags.includes(tag);
        (item as HTMLElement).style.display = show ? '' : 'none';
        if (show) visibleCount++;
      });

      // Empty message
      if (emptyMsg) emptyMsg.style.display = visibleCount > 0 ? 'none' : '';
    });
  });

  // Reorder: current locale posts first via CSS order
  postItems.forEach((item) => {
    const postLang = (item as HTMLElement).dataset.lang || 'zh';
    (item as HTMLElement).style.order = postLang === locale ? '-1' : '0';
  });
</script>
