---
import type { ImageMetadata } from 'astro';
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import PostCard from '../../components/PostCard.astro';
import FadeContent from '../../components/FadeContent';
import SplitText from '../../components/SplitText';
import { Badge } from '../../components/ui/badge';
import { getPostSlug, prefetchWaifuBatch, resolvePostCover } from '../../lib/blog';

const allPosts = (await getCollection('blog'))
  .filter((post) => !post.data.draft)
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

// Pre-fetch waifu URLs in one parallel batch for posts without covers
const uncoveredCount = allPosts.filter((p) => !p.data.cover).length;
await prefetchWaifuBatch(uncoveredCount);

const postsWithCovers = await Promise.all(
  allPosts.map(async (post) => ({
    ...post,
    cover: await resolvePostCover(post.data.cover) as ImageMetadata | string | undefined,
  }))
);

const allTags = [...new Set(allPosts.flatMap((p) => p.data.tags))].sort();

const selectedTag = Astro.url.searchParams.get('tag');
const posts = selectedTag
  ? postsWithCovers.filter((p) => p.data.tags.includes(selectedTag))
  : postsWithCovers;
---

<BaseLayout title="博客 — 限制解除！" description="所有博客文章">
  <div class="mb-8">
    <SplitText
      client:visible
      text="博客文章"
      tag="h1"
      splitType="chars"
      delay={40}
      duration={0.8}
      ease="power3.out"
      textAlign="left"
      className="text-3xl font-bold font-tech"
    />
  </div>

  {allTags.length > 0 && (
    <div class="mb-8 flex flex-wrap gap-2">
      <a href="/blog">
        <Badge
          variant={!selectedTag ? 'default' : 'outline'}
          className="cursor-pointer font-tech text-xs hover:bg-primary/10 transition-colors"
        >
          全部
        </Badge>
      </a>
      {allTags.map((tag) => (
        <a href={`/blog?tag=${encodeURIComponent(tag)}`}>
          <Badge
            variant={selectedTag === tag ? 'default' : 'outline'}
            className="cursor-pointer font-tech text-xs hover:bg-primary/10 transition-colors"
          >
            #{tag}
          </Badge>
        </a>
      ))}
    </div>
  )}

  {selectedTag && (
    <div class="mb-6 flex items-center gap-2 text-sm text-muted-foreground">
      <span>筛选: <strong class="text-foreground">#{selectedTag}</strong></span>
      <a href="/blog" class="text-primary hover:underline text-xs">清除</a>
    </div>
  )}

  {posts.length === 0 ? (
    <p class="text-muted-foreground py-12 text-center">没有找到相关文章</p>
  ) : (
    <div class="grid gap-4 md:grid-cols-2">
      {posts.map((post, i) => (
        <FadeContent client:visible delay={i * 80} duration={500} blur={true}>
          <PostCard
            title={post.data.title}
            description={post.data.description}
            pubDate={post.data.pubDate}
            tags={post.data.tags}
            slug={getPostSlug(post.id)}
            cover={post.cover}
          />
        </FadeContent>
      ))}
    </div>
  )}
</BaseLayout>
